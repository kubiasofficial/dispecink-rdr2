<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Dispeƒçink v1.40 - CRC</title>
    <style>
        :root {
            --bg-color: #0d0d0d; --card-bg: rgba(25, 25, 25, 0.98);
            --accent: #c0a060; --danger: #ff4444; --info: #44ccff;
            --success: #4caf50; --border: #3d3d3d;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: #e0e0e0; display: flex; justify-content: center; padding: 20px; }
        .card { background: var(--card-bg); border: 1px solid var(--border); padding: 30px; border-radius: 12px; width: 750px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        
        #setup-mode, #drive-mode, #report-mode { display: none; }
        .active-mode { display: block !important; }

        h2 { color: var(--accent); text-align: center; border-bottom: 2px solid #8b0000; padding-bottom: 15px; text-transform: uppercase; letter-spacing: 5px; margin-top: 0; }
        
        #navigator { padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: center; border: 1px solid var(--border); position: relative; }
        .state-station { background: linear-gradient(135deg, #162e4d 0%, #08111d 100%); border-color: var(--info) !important; }
        .state-travel { background: linear-gradient(135deg, #4d2b00 0%, #1a0f00 100%); border-color: #ffa500 !important; }
        
        #nav-timer-container { font-size: 4.5em; font-weight: 800; font-family: 'Courier New', monospace; line-height: 1; }
        .gvd-container { width: 100%; height: 10px; background: #000; border-radius: 5px; margin: 20px 0 10px 0; border: 1px solid #333; overflow: hidden; }
        #gvd-fill { width: 0%; height: 100%; background: linear-gradient(to right, #c0a060, #8b0000); transition: 0.5s; }

        .info-bar { display: flex; justify-content: space-around; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
        .info-item { text-align: center; }
        .info-label { font-size: 0.7em; color: #888; text-transform: uppercase; display: block; }
        .info-val { font-size: 1.2em; font-weight: bold; }

        .btn { padding: 15px 25px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; text-transform: uppercase; transition: 0.2s; width: 100%; }
        .btn-confirm { background: #fff; color: #000; font-size: 1.2em; box-shadow: 0 4px 0 #bbb; margin-top: 15px; }
        .btn-main { background: linear-gradient(to bottom, #8b0000, #5a0000); color: white; margin-top: 20px; }
        .btn-discord { background: #5865F2; color: white; margin-top: 10px; }

        .grid-config { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        label { font-size: 0.75em; color: var(--accent); margin-bottom: 5px; display: block; }
        select, input { background: #222; border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; }
        
        .list { margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px; font-family: monospace; max-height: 250px; overflow-y: auto; }
        .item-row { display: flex; justify-content: space-between; padding: 8px 10px; border-bottom: 1px solid #222; opacity: 0.4; }
        .active-row { opacity: 1; color: var(--accent); background: rgba(192, 160, 96, 0.1); font-weight: bold; border-left: 3px solid var(--accent); }
        .tag { color: var(--accent); font-size: 0.7em; margin-left: 5px; border: 1px solid var(--accent); padding: 1px 4px; }
    </style>
</head>
<body>

<div class="card">
    <h2>üöÇ DISPEƒåINK CRC v1.40</h2>

    <div id="setup-mode" class="active-mode">
        <label>V√ùBƒöR TRASY:</label>
        <select id="routeSelect" style="margin-bottom: 15px;">
            <option value="l1">1. HLAVN√ç OKRUH (Interval 5m)</option>
            <option value="l2">2. Z√ÅPADN√ç SPOJKA (Interval 6m)</option>
            <option value="l3">3. V√ùCHODN√ç DR√ÅHA (Interval 5m)</option>
            <option value="l4">4. JI≈ΩN√ç CESTA (Interval 7m)</option>
        </select>

        <div class="grid-config">
            <div><label>START:</label><input type="time" id="startTime" value="12:00"></div>
            <div><label>KOL DNES:</label><input type="number" id="lapCount" value="4" min="1"></div>
            <div><label>HISTORIE (CELKEM):</label><input type="number" id="prevTotal" value="0" min="0"></div>
            <div><label>PAUZA SD (min):</label><input type="number" id="pauseTime" value="5"></div>
        </div>

        <button class="btn btn-main" onclick="generovat()">‚öôÔ∏è GENEROVAT J√çZDN√ç ≈ò√ÅD</button>
        <button id="startBtn" class="btn btn-discord" style="display:none;" onclick="startDrive()">üöÄ POTVRDIT A ODJET</button>
        <div id="preview-list" class="list"></div>
    </div>

    <div id="drive-mode">
        <div class="info-bar">
            <div class="info-item"><span class="info-label">Dochvilnost</span><span id="hud-delay" class="info-val">VƒåAS</span></div>
            <div class="info-item"><span class="info-label">Kolo</span><span id="hud-lap" class="info-val">1</span></div>
            <div class="info-item"><span class="info-label">Tr≈æba</span><span id="hud-cash" class="info-val">0 $</span></div>
        </div>

        <div id="navigator">
            <div style="display:flex; justify-content: space-between; font-weight: bold; color: var(--accent);">
                <span>PL√ÅNOVAN√ù ƒåAS:</span><span id="hud-planned-time">--:--</span>
            </div>
            <div id="nav-main" style="font-size: 2em; font-weight: 900; margin: 10px 0;">STATION ‚ûî STATION</div>
            <div id="nav-timer-container">0:00</div>
            <div class="gvd-container"><div id="gvd-fill"></div></div>
            <button id="confirmBtn" class="btn btn-confirm" onclick="handleAction()">POTVRDIT P≈ò√çJEZD / ODJEZD</button>
        </div>
        <div id="active-list" class="list"></div>
    </div>

    <div id="report-mode" style="text-align: center;">
        <h3 style="color:var(--success)">‚úÖ SMƒöNA DOKONƒåENA</h3>
        <div id="final-stats" style="background:rgba(0,0,0,0.3); padding:20px; border-radius:8px; margin-bottom:20px; text-align:left;"></div>
        <button class="btn btn-main" onclick="location.reload()">üîÑ NOV√Å SMƒöNA</button>
    </div>
</div>

<script>
    const WEBHOOK_LOG = "https://discord.com/api/webhooks/1462379181290553378/7szxSP1bgAiR1diwDixyPPrXxklYWVGdLn3xZy8czqxGbqda9wtryXNV_zqJXL3PHGKO";
    
    // Definice linek dle tv√©ho zad√°n√≠
    const dataTras = {
        l1: { n: "1. HLAVN√ç OKRUH", i: 5, s: ["Saint Denis", "Emerald", "Valentine", "Flatneck", "Riggs", "Wallace", "Bacchus", "Annesburg", "Van Horn", "Saint Denis"], l: "Saint Denis", u: "Wallace" },
        l2: { n: "2. Z√ÅPADN√ç SPOJKA", i: 6, s: ["Saint Denis", "Rhodes", "Flatneck", "Blackwater", "MacFarlane's Ranch", "Montana", "Flatneck", "Valentine", "Saint Denis"], l: "Saint Denis", u: "MacFarlane's Ranch" },
        l3: { n: "3. V√ùCHODN√ç DR√ÅHA", i: 5, s: ["Saint Denis", "Van Horn", "Annesburg", "Bacchus Station", "Wallace Station", "Riggs Station", "Flatneck Station", "Rhodes"], l: "Saint Denis", u: "Wallace Station" },
        l4: { n: "4. JI≈ΩN√ç CESTA", i: 7, s: ["Saint Denis", "Rhodes", "Flatneck", "Riggs", "Blackwater", "Riggs", "Flatneck", "Saint Denis"], l: "Saint Denis", u: "Benedict Point" }
    };

    let state = { tickets: 0, icName: "", navBody: [], currentIndex: 0, interval: null, smenaData: [], routeName: "" };

    function generovat() {
        state.navBody = []; state.smenaData = [];
        const rKey = document.getElementById('routeSelect').value;
        const r = dataTras[rKey];
        state.routeName = r.n;
        const laps = parseInt(document.getElementById('lapCount').value);
        const pause = parseInt(document.getElementById('pauseTime').value);
        const startParts = document.getElementById('startTime').value.split(':');
        let curMin = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);

        for (let l = 1; l <= laps; l++) {
            let lapDesc = "";
            r.s.forEach((st, idx) => {
                let cargo = (st === r.l || st === r.u);
                if (idx > 0) {
                    curMin += r.i; // P≈ôid√°n√≠ intervalu p≈ôejezdu
                    state.navBody.push({ type: 'travel', from: r.s[idx-1], to: st, end: curMin });
                }
                
                let arrival = curMin;
                if (cargo) curMin += 3; // Automatick√© 3 minuty na telegram

                state.navBody.push({ type: 'station', name: st, end: curMin, lap: l, cargo: st === r.l ? "üì•" : (st === r.u ? "üì§" : "") });
                lapDesc += `\`${formatTime(curMin)}\` **${st}** ${st === r.l ? "[üì• NAKL√ÅDKA]" : (st === r.u ? "[üì§ VYKL√ÅDKA]" : "")}\n`;
            });
            state.smenaData.push({ title: `${l}. KOLO`, desc: lapDesc });
            if (l < laps) { 
                state.navBody.push({ type: 'pause', end: curMin + pause }); 
                curMin += pause; 
            }
        }
        document.getElementById('startBtn').style.display = "block";
        renderList('preview-list');
    }

    async function startDrive() {
        state.icName = prompt("Zadej sv√© jm√©no:", state.icName || "Elizabeth Brown");
        if(!state.icName) return;
        localStorage.setItem('prevTotal', document.getElementById('prevTotal').value);
        switchMode('drive-mode');
        
        fetch(WEBHOOK_LOG, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({
            username: "CRC Dispeƒçink", embeds: [{ title: "üöÇ START SMƒöNY", description: `**Strojv≈Ødce:** ${state.icName}\n**Trasa:** ${state.routeName}`, color: 3066993 }]
        })});

        runNavigator(); 
        renderList('active-list');
    }

    function runNavigator() {
        state.interval = setInterval(() => {
            const active = state.navBody[state.currentIndex];
            if (!active) { finishSmƒõna(); return; }
            
            const now = new Date();
            const nowMin = now.getHours() * 60 + now.getMinutes() + (now.getSeconds() / 60);
            let remains = Math.round((active.end - nowMin) * 60);
            
            // UI Update
            document.getElementById('nav-timer-container').innerText = remains < 0 ? "0:00" : `${Math.floor(remains/60)}:${(remains%60).toString().padStart(2,'0')}`;
            document.getElementById('nav-timer-container').style.color = remains < 0 ? "var(--danger)" : "white";
            document.getElementById('hud-planned-time').innerText = formatTime(active.end);
            document.getElementById('hud-lap').innerText = active.lap || "-";
            
            document.getElementById('nav-main').innerText = active.type === 'station' ? `üìç ${active.name}` : (active.type === 'pause' ? "‚òï PAUZA SD" : `${active.from} ‚ûî ${active.to}`);
            document.getElementById('navigator').className = active.type === 'station' ? "state-station" : "state-travel";
            
            const progress = (state.currentIndex / state.navBody.length) * 100;
            document.getElementById('gvd-fill').style.width = progress + "%";
            
            // HUD Zpo≈ædƒõn√≠
            let delay = Math.round(nowMin - active.end);
            let dEl = document.getElementById('hud-delay');
            if(delay > 0) { dEl.innerText = `+${delay} MIN`; dEl.style.color = "var(--danger)"; }
            else { dEl.innerText = "VƒåAS"; dEl.style.color = "var(--success)"; }
        }, 1000);
    }

    function handleAction() {
        const active = state.navBody[state.currentIndex];
        if (active.type === 'travel') {
            let t = prompt("Poƒçet j√≠zdenek:", "0");
            state.tickets += (parseInt(t) || 0);
            document.getElementById('hud-cash').innerText = `${state.tickets * 5} $`;
        }
        state.currentIndex++; 
        renderList('active-list');
    }

    function finishSmƒõna() {
        clearInterval(state.interval); switchMode('report-mode');
        const laps = parseInt(document.getElementById('lapCount').value);
        const total = (parseInt(localStorage.getItem('prevTotal')) || 0) + laps;
        document.getElementById('final-stats').innerHTML = `<b>üë§ Strojv≈Ødce:</b> ${state.icName}<br><b>üìà Kola:</b> ${laps} (Celkem: ${total})<br><b>üé´ J√≠zdenky:</b> ${state.tickets} ($ ${state.tickets * 5})`;
    }

    function switchMode(id) {
        document.querySelectorAll('#setup-mode, #drive-mode, #report-mode').forEach(m => m.classList.remove('active-mode'));
        document.getElementById(id).classList.add('active-mode');
    }

    function renderList(targetId) {
        const list = document.getElementById(targetId); list.innerHTML = "";
        state.navBody.forEach((b, i) => {
            if (b.type === 'station') {
                const row = document.createElement('div');
                row.className = `item-row ${i === state.currentIndex ? 'active-row' : ''}`;
                row.innerHTML = `<span>${b.name} ${b.cargo ? `<span class="tag">${b.cargo}</span>`:''}</span><b>${formatTime(b.end)}</b>`;
                list.appendChild(row);
            }
        });
    }

    function formatTime(m) { return `${Math.floor(m/60)%24}:${(Math.floor(m%60)).toString().padStart(2,'0')}`; }
</script>
</body>
</html>
