<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Služební kniha CRC - Elizabeth Brown</title>
    <style>
        :root {
            --bg: #1e1c1a; 
            --card: #2d2a27; 
            --accent: #b09060; 
            --text: #d2c1ae; 
            --success: #4a5d43; 
        }
        body { font-family: 'Georgia', serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 20px; }
        .container { background: var(--card); border: 1px solid var(--accent); border-radius: 4px; width: 600px; padding: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); position: relative; }
        
        .container::before { content: ""; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px; border: 1px solid rgba(176, 144, 96, 0.1); pointer-events: none; }

        h1, h2 { text-align: center; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; margin-top: 0; font-weight: normal; }
        h1 { border-bottom: 2px double var(--accent); padding-bottom: 10px; margin-bottom: 5px; }
        .subtitle { text-align: center; font-size: 0.8em; letter-spacing: 4px; color: var(--accent); margin-bottom: 30px; text-transform: uppercase; }
        
        .hidden { display: none; }
        .step { animation: fadeIn 0.6s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        select, button, input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 2px; border: none; font-family: 'Georgia', serif; font-size: 1em; box-sizing: border-box; }
        select, input { background: #1a1816; color: var(--text); border: 1px solid #4d453d; }
        
        .btn-start { background: var(--accent); color: #1a1816; cursor: pointer; text-transform: uppercase; font-weight: bold; border: 1px solid var(--accent); }
        .btn-shift { background: transparent; color: var(--accent); border: 1px solid var(--accent); cursor: pointer; transition: 0.3s; margin-bottom: 10px; }
        .btn-shift:hover { background: rgba(176, 144, 96, 0.1); }
        .btn-confirm { background: var(--success); color: white; cursor: pointer; text-transform: uppercase; font-weight: bold; }

        .info-box { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 2px; border-left: 3px solid var(--accent); margin-bottom: 20px; font-style: italic; color: #b0a090; }
        #active-timetable { font-family: 'Courier New', monospace; background: #141210; padding: 15px; border: 1px inset #333; color: #a0a0a0; line-height: 1.6; font-size: 0.9em; }
        label { font-size: 0.75em; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; display: block; margin-top: 15px; }
        .timetable-row { display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding: 5px 0; }
        
        hr { border: 0; border-top: 1px solid #4d453d; margin: 25px 0; }
    </style>
</head>
<body>

<div class="container">
    <h1>CONTINENTAL RAIL COMPANY</h1>
    <p class="subtitle">Služební kniha strojvůdce - Protokol 1899</p>

    <div id="step-1" class="step">
        <h2>[ IDENTIFIKACE ]</h2>
        <label>Jméno odpovědného strojvůdce:</label>
        <select id="user-select">
            <option value="Elizabeth Brown">Elizabeth Brown</option>
        </select>
        <button class="btn-start" onclick="goToStep2()">OTEVŘÍT SLUŽEBNÍ KNIHU</button>
    </div>

    <div id="step-2" class="step hidden">
        <h2>[ DENNÍ ROZPIS ]</h2>
        <p style="text-align:center; font-size: 0.9em; margin-bottom: 20px;">Zvolte přidělený časový blok:</p>
        <button class="btn-shift" onclick="generateShift('ranni')">§ RANNÍ SLUŽBA (05:00 - 15:00)</button>
        <button class="btn-shift" onclick="generateShift('odpoledni')">§ ODPOLEDNÍ SLUŽBA (15:00 - 22:00)</button>
        <button class="btn-shift" onclick="generateShift('nocni')">§ NOČNÍ SLUŽBA (22:00 - 05:00)</button>
    </div>

    <div id="step-3" class="step hidden">
        <h2>[ PŘEVZETÍ SLUŽBY ]</h2>
        <div class="info-box" id="shift-preview"></div>
        <p style="text-align:center; font-size: 0.8em; font-style: italic;">Potvrzením stvrzujete převzetí lokomotivy v řádném stavu.</p>
        <button class="btn-start" onclick="startShift()">PODEPSAT A NASTOUPIT K JÍZDĚ</button>
    </div>

    <div id="step-telegrams" class="step hidden">
        <h2>[ POŠTOVNÍ MANIPULACE ]</h2>
        <label>» Místo nakládky zásilek:</label>
        <select id="telegrams-in"></select>
        <label>» Místo vykládky zásilek:</label>
        <select id="telegrams-out"></select>
        <button class="btn-start" onclick="confirmTelegrams()">ZAPSAT DO PROTOKOLU</button>
    </div>

    <div id="step-4" class="step hidden">
        <h2 id="active-title">PROTOKOL JÍZDY</h2>
        <div class="info-box">
            <div id="active-route-name" style="font-weight:bold; color:var(--accent); text-align:center; margin-bottom:10px;">--</div>
            <div id="active-timetable"></div>
        </div>
        <label>Počet jízdenek zapsaných v cíli:</label>
        <input type="number" id="tickets-input" value="0">
        <button class="btn-confirm" onclick="completeRoute()">UZAVŘÍT LIST LÍNIE</button>
    </div>

    <div id="step-5" class="step hidden">
        <h2>[ KONEC SLUŽEBNÍHO ZÁZNAMU ]</h2>
        <div id="final-report" class="info-box"></div>
        <button class="btn-start" onclick="location.reload()">UZAVŘÍT KNIHU</button>
    </div>
</div>

<script>
    // Webhooky pro Elizabeth
    const WEBHOOK_LOG = "https://discord.com/api/webhooks/1462379181290553378/7szxSP1bgAiR1diwDixyPPrXxklYWVGdLn3xZy8czqxGbqda9wtryXNV_zqJXL3PHGKO";
    const WEBHOOK_RAD = "https://discord.com/api/webhooks/1462391755864277033/mQ1n6EsyC-yEuEc7hZTYsm8Jt9VjnUGr-jPVM2qjvVSSkisoS2Cpl1DSi1Oe7lUnBd6J";
    const WEBHOOK_BW = "https://discord.com/api/webhooks/1463245037834862616/M_myizEOqBJjE84_5MKqNQdRlY4S1P6EHBA3JnYxOw2mdYYn0kt609sc8MIz1v3e4PkV";

    const trasy = [
        { id: 'hlavni', n: "LINIE I. - CRC HLAVNÍ OKRUH", gap: 5, stop: ["Saint Denis", "Emerald", "Valentine", "Flatneck", "Riggs", "Wallace", "Bacchus", "Annesburg", "Van Horn", "Saint Denis"] },
        { id: 'zapadni', n: "LINIE II. - CRC ZÁPADNÍ SPOJKA", gap: 6, stop: ["Saint Denis", "Rhodes", "Flatneck", "Blackwater", "MacFarlane", "Montana", "Flatneck", "Valentine", "Saint Denis"] },
        { id: 'vychodni', n: "LINIE III. - CRC VÝCHODNÍ DRÁHA", gap: 5, stop: ["Saint Denis", "Van Horn", "Annesburg", "Bacchus", "Wallace", "Riggs", "Flatneck", "Rhodes", "Saint Denis"] },
        { id: 'jizni', n: "LINIE IV. - CRC JIŽNÍ CESTA", gap: 6, stop: ["Saint Denis", "Valentine", "Flatneck", "Blackwater", "MacFarlane", "Armadillo", "Mercer", "Benedict Point", "Mercer", "Armadillo", "MacFarlane", "Blackwater", "Flatneck", "Valentine", "Saint Denis"] }
    ];

    let shiftData = { worker: "", type: "", routes: [], currentIndex: 0, totalTickets: 0, startTimeReal: null, telegrams: { in: "", out: "" } };

    function showStep(s) {
        ['1', '2', '3', '4', '5', 'telegrams'].forEach(id => document.getElementById('step-' + id).classList.add('hidden'));
        document.getElementById('step-' + s).classList.remove('hidden');
    }

    function goToStep2() {
        shiftData.worker = document.getElementById('user-select').value;
        showStep(2);
    }

    function generateShift(typ) {
        shiftData.type = typ;
        let limit = (typ === 'ranni') ? 600 : 420; 
        let allocated = 0;
        shiftData.routes = [];
        while (allocated < (limit - 80)) {
            let randomTrasa = trasy[Math.floor(Math.random() * trasy.length)];
            shiftData.routes.push({ name: randomTrasa.n, stops: randomTrasa.stop, gap: randomTrasa.gap });
            allocated += (randomTrasa.stop.length * randomTrasa.gap + 15);
        }
        document.getElementById('shift-preview').innerHTML = `PRACOVNÍK: ${shiftData.worker}<br>SMĚNA: ${shiftData.type.toUpperCase()}<br>LINIÍ K ODBAVENÍ: ${shiftData.routes.length}`;
        showStep(3);
    }

    async function startShift() {
        shiftData.startTimeReal = new Date();
        await fetch(WEBHOOK_LOG, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                content: `--- [ CRC ZÁPIS ] ---\nStrojvůdce **${shiftData.worker}** nastupuje do služby.\n*Podpis: ${shiftData.worker} v.r.*` 
            })
        });
        prepareTelegrams();
    }

    function prepareTelegrams() {
        let route = shiftData.routes[shiftData.currentIndex];
        let inS = document.getElementById('telegrams-in');
        let outS = document.getElementById('telegrams-out');
        inS.innerHTML = ""; outS.innerHTML = "";
        route.stops.forEach(s => { inS.add(new Option(s, s)); outS.add(new Option(s, s)); });
        showStep('telegrams');
    }

    function confirmTelegrams() {
        shiftData.telegrams.in = document.getElementById('telegrams-in').value;
        shiftData.telegrams.out = document.getElementById('telegrams-out').value;
        updateActiveRoute();
    }

    function updateActiveRoute() {
        let route = shiftData.routes[shiftData.currentIndex];
        document.getElementById('active-title').innerText = `KNIHA JÍZD ${shiftData.currentIndex + 1}/${shiftData.routes.length}`;
        document.getElementById('active-route-name').innerText = route.name;
        
        let now = new Date();
        let timetableHTML = "";
        let timetableDiscord = "";
        let bwDepeše = "";

        route.stops.forEach((s, index) => {
            let t = new Date(now.getTime() + (index * route.gap * 60000));
            let timeStr = t.getHours().toString().padStart(2, '0') + ":" + t.getMinutes().toString().padStart(2, '0');
            timetableHTML += `<div class="timetable-row"><span>${s}</span><span>${timeStr}</span></div>`;
            timetableDiscord += `${timeStr} - ${s}\n`;
            if (s === "Blackwater") bwDepeše += `> ${timeStr}\n`;
        });

        document.getElementById('active-timetable').innerHTML = timetableHTML;

        fetch(WEBHOOK_RAD, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                content: `--- [ CRC DEPEŠE ] ---\nSTROJVŮDCE: ${shiftData.worker}\nLINIE: ${route.name}\nPOŠTA: ${shiftData.telegrams.in} >> ${shiftData.telegrams.out}\n\nJÍZDNÍ ŘÁD:\n\`\`\`\n${timetableDiscord}\n\`\`\`\nSignatum: ${shiftData.worker} v.r.` 
            })
        });

        if(bwDepeše) {
            fetch(WEBHOOK_BW, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ content: `[ CRC BLACKWATER ]\nLinie: ${route.name}\n${bwDepeše}\nPodepsán: ${shiftData.worker} v.r.` })});
        }
        showStep(4);
    }

    function completeRoute() {
        shiftData.totalTickets += (parseInt(document.getElementById('tickets-input').value) || 0);
        document.getElementById('tickets-input').value = 0;
        shiftData.currentIndex++;
        if (shiftData.currentIndex < shiftData.routes.length) prepareTelegrams();
        else finishShift();
    }

    async function finishShift() {
        let endTime = new Date();
        let diff = Math.floor((Math.abs(endTime - shiftData.startTimeReal) / 1000) / 60);
        document.getElementById('final-report').innerHTML = `STŘÍDÁNÍ: ${shiftData.worker}<br>JÍZDENKY: ${shiftData.totalTickets}<br>DOBA: ${diff} min`;
        await fetch(WEBHOOK_LOG, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                embeds: [{ 
                    title: "[ KONEC SLUŽEBNÍHO ZÁZNAMU ]", 
                    description: `Strojvůdce: ${shiftData.worker}\nJízdenky: ${shiftData.totalTickets}\nMinut v sedle: ${diff}\n\n*Signatum: ${shiftData.worker} v.r.*`,
                    color: 11178080 
                }]
            })
        });
        showStep(5);
    }
</script>
</body>
</html>
