<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Slu≈æebn√≠ kniha CRC - Interaktivn√≠ Protokol</title>
    <style>
        :root { --bg: #1e1c1a; --card: #2d2a27; --accent: #b09060; --text: #d2c1ae; --success: #4a5d43; --danger: #8b2e2e; --modal-bg: rgba(0,0,0,0.95); }
        body { font-family: 'Georgia', serif; background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; padding: 20px; }
        .container { background: var(--card); border: 1px solid var(--accent); width: 700px; padding: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); position: relative; }
        
        /* Horn√≠ li≈°ta s informacemi */
        .status-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: rgba(0,0,0,0.5); padding: 15px; border: 1px solid #4d453d; margin-bottom: 25px; border-radius: 4px; text-align: center; }
        .stat-item { font-size: 0.85rem; display: flex; flex-direction: column; gap: 5px; border-right: 1px solid #444; }
        .stat-item:last-child { border-right: none; }
        .stat-val { font-weight: bold; font-size: 1.1rem; color: var(--accent); }
        .delay-bad { color: var(--danger); }
        .delay-good { color: var(--success); }
        
        /* Mod√°ln√≠ okna */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: var(--modal-bg); backdrop-filter: blur(5px); }
        .modal-content { background: var(--card); margin: 10% auto; padding: 30px; border: 1px solid var(--accent); width: 400px; text-align: center; box-shadow: 0 0 50px #000; }
        
        h1, h2 { text-align: center; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; }
        .hidden { display: none; }
        button { width: 100%; padding: 12px; margin: 10px 0; cursor: pointer; font-family: 'Georgia', serif; text-transform: uppercase; font-weight: bold; border-radius: 2px; border: 1px solid var(--accent); transition: 0.2s; }
        .btn-gold { background: var(--accent); color: #1a1816; }
        .btn-green { background: var(--success); color: white; border: none; }
        .btn-outline { background: transparent; color: var(--accent); }
        button:hover { filter: brightness(1.2); }
        
        input { width: 100%; padding: 10px; background: #1a1816; color: var(--text); border: 1px solid #4d453d; text-align: center; margin: 10px 0; box-sizing: border-box; font-size: 1.2rem; }
        #active-timetable { font-family: 'Courier New', monospace; background: #141210; padding: 15px; border: 1px inset #333; line-height: 1.8; }
        .station-row { display: flex; justify-content: space-between; padding: 8px 15px; border-bottom: 1px solid #222; cursor: pointer; }
        .station-row:hover { background: rgba(176, 144, 96, 0.1); }
        .station-row.completed { color: #666; text-decoration: line-through; cursor: default; }
        .station-row.next { border-left: 4px solid var(--accent); background: rgba(176, 144, 96, 0.05); }
    </style>
</head>
<body>

<div class="container">
    <h1>CONTINENTAL RAIL COMPANY</h1>
    
    <div id="status-display" class="status-bar hidden">
        <div class="stat-item">
            <span>V√ùDƒöLEK</span>
            <span id="stat-money" class="stat-val">0 USD</span>
        </div>
        <div class="stat-item">
            <span>J√çZDENKY</span>
            <span id="stat-tickets" class="stat-val">0 Ks</span>
        </div>
        <div class="stat-item">
            <span>KOLO / HISTORIE</span>
            <span id="stat-round" class="stat-val">1 / 0</span>
        </div>
        <div class="stat-item">
            <span>ZPO≈ΩDƒöN√ç</span>
            <span id="stat-delay" class="stat-val">Vƒças</span>
        </div>
    </div>

    <div id="step-1" class="step">
        <h2>[ IDENTIFIKACE ]</h2>
        <label>Jm√©no strojv≈Ødce:</label>
        <select id="user-select" style="width:100%; padding:12px; background:#1a1816; color:var(--text); border:1px solid #4d453d;">
            <option value="Elizabeth Brown">Elizabeth Brown</option>
            <option value="Joshue Thorne">Joshue Thorne</option>
            <option value="Henry Brown">Henry Brown</option>
            <option value="Nicholas Carter">Nicholas Carter</option>
        </select>
        <label style="display:block; margin-top:15px;">Poƒçet kol p≈ôed zaƒç√°tkem smƒõny (Historie):</label>
        <input type="number" id="initial-rounds" value="0">
        <button class="btn-gold" onclick="goToStep2()">OTEV≈ò√çT SLU≈ΩEBN√ç KNIHU</button>
    </div>

    <div id="step-2" class="step hidden">
        <h2>[ VOLBA SLU≈ΩBY ]</h2>
        <button class="btn-outline" onclick="generateShift('ranni')">¬ß RANN√ç (05:00 - 15:00)</button>
        <button class="btn-outline" onclick="generateShift('odpoledni')">¬ß ODPOLEDN√ç (15:00 - 22:00)</button>
        <button class="btn-outline" onclick="generateShift('nocni')">¬ß NOƒåN√ç (22:00 - 05:00)</button>
    </div>

    <div id="step-4" class="step hidden">
        <h2 id="active-title">PROTOKOL J√çZDY</h2>
        <div id="active-timetable"></div>
        <p style="text-align:center; font-size:0.8rem; font-style:italic; margin-top:15px; color: var(--accent);">
            * Kliknƒõte na stanici ihned po zastaven√≠ u v√Ωpravƒç√≠ho. *
        </p>
    </div>

    <div id="step-5" class="step hidden">
        <h2>[ KONEC SLU≈ΩEBN√çHO Z√ÅZNAMU ]</h2>
        <div id="final-summary" style="background:rgba(0,0,0,0.2); padding:20px; line-height:2; border: 1px solid #444;"></div>
        <button class="btn-gold" onclick="location.reload()">UZAV≈ò√çT KNIHU</button>
    </div>
</div>

<div id="dispatch-modal" class="modal">
    <div class="modal-content">
        <h3 id="dispatch-text"></h3>
        <button class="btn-green" onclick="handleArrival(true)">ANO</button>
        <button class="btn-outline" onclick="handleArrival(false)">NE (POƒåKAT 60S)</button>
    </div>
</div>

<div id="ticket-modal" class="modal">
    <div class="modal-content">
        <h3>Z√ÅZNAM PRODAN√ùCH J√çZDENEK</h3>
        <p id="ticket-station-name" style="color:var(--accent)"></p>
        <input type="number" id="current-tickets" value="0" min="0" onfocus="this.select()">
        <button class="btn-gold" onclick="saveTickets()">UKLIDIT BRA≈†NU</button>
    </div>
</div>

<div id="departure-modal" class="modal">
    <div class="modal-content">
        <h3 id="departure-text"></h3>
        <button class="btn-green" onclick="closeDeparture()">ANO, ODJ√ç≈ΩD√çM</button>
    </div>
</div>

<audio id="coin-sound" src="mixkit-clinking-coins-1993.wav"></audio>

<script>
    const WEBHOOK_LOG = "https://discord.com/api/webhooks/1462379181290553378/7szxSP1bgAiR1diwDixyPPrXxklYWVGdLn3xZy8czqxGbqda9wtryXNV_zqJXL3PHGKO";
    
    const trasy = [
        { n: "LINIE I. - HLAVN√ç OKRUH", gap: 5, stop: ["Saint Denis", "Emerald", "Valentine", "Flatneck", "Riggs", "Wallace", "Bacchus", "Annesburg", "Van Horn", "Saint Denis"] },
        { n: "LINIE II. - Z√ÅPADN√ç SPOJKA", gap: 6, stop: ["Saint Denis", "Rhodes", "Flatneck", "Blackwater", "MacFarlane", "Montana", "Flatneck", "Valentine", "Saint Denis"] }
    ];

    let shiftData = { 
        worker: "", 
        initialRounds: 0, 
        currentRound: 1, 
        totalTickets: 0, 
        totalMoney: 0,
        currentRoute: null,
        currentStationIdx: 0,
        startTime: null,
        timetableData: [] // Ukl√°d√° vypoƒç√≠tan√© ƒçasy pro porovn√°n√≠
    };

    function goToStep2() {
        shiftData.worker = document.getElementById('user-select').value;
        shiftData.initialRounds = parseInt(document.getElementById('initial-rounds').value) || 0;
        document.getElementById('step-1').classList.add('hidden');
        document.getElementById('step-2').classList.remove('hidden');
    }

    function generateShift(typ) {
        shiftData.currentRoute = trasy[Math.floor(Math.random() * trasy.length)];
        shiftData.startTime = new Date();
        
        // P≈ôedv√Ωpoƒçet j√≠zdn√≠ho ≈ô√°du
        shiftData.timetableData = shiftData.currentRoute.stop.map((s, i) => {
            return new Date(shiftData.startTime.getTime() + (i * shiftData.currentRoute.gap * 60000));
        });

        startRoute();
    }

    function startRoute() {
        document.getElementById('step-2').classList.add('hidden');
        document.getElementById('status-display').classList.remove('hidden');
        document.getElementById('step-4').classList.remove('hidden');
        renderTimetable();
    }

    function renderTimetable() {
        let html = "";
        shiftData.currentRoute.stop.forEach((s, i) => {
            let t = shiftData.timetableData[i];
            let timeStr = t.getHours().toString().padStart(2, '0') + ":" + t.getMinutes().toString().padStart(2, '0');
            let statusClass = i < shiftData.currentStationIdx ? "completed" : (i === shiftData.currentStationIdx ? "next" : "");
            html += `<div class="station-row ${statusClass}" onclick="triggerArrival(${i})">
                        <span>${s}</span><span>${timeStr}</span>
                     </div>`;
        });
        document.getElementById('active-timetable').innerHTML = html;
        document.getElementById('stat-round').innerText = `${shiftData.currentRound} / ${shiftData.initialRounds}`;
    }

    function triggerArrival(idx) {
        if (idx !== shiftData.currentStationIdx) return;
        
        // V√ùPOƒåET ZPO≈ΩDƒöN√ç
        let now = new Date();
        let scheduled = shiftData.timetableData[idx];
        let diffMs = now - scheduled;
        let diffMins = Math.floor(diffMs / 60000);

        let delayEl = document.getElementById('stat-delay');
        if (diffMins > 0) {
            delayEl.innerText = `+${diffMins} min`;
            delayEl.className = "stat-val delay-bad";
        } else {
            delayEl.innerText = "Vƒças";
            delayEl.className = "stat-val delay-good";
        }

        const station = shiftData.currentRoute.stop[idx];
        document.getElementById('dispatch-text').innerText = `V√Ωpravƒç√≠ stanice ${station} se kouk√°, jestli u≈æ jsi p≈ôijel/a?`;
        document.getElementById('dispatch-modal').style.display = 'block';
    }

    function handleArrival(arrived) {
        document.getElementById('dispatch-modal').style.display = 'none';
        if (arrived) {
            const station = shiftData.currentRoute.stop[shiftData.currentStationIdx];
            document.getElementById('ticket-station-name').innerText = `P≈ô√≠jezd: ${station}`;
            document.getElementById('ticket-modal').style.display = 'block';
        } else {
            setTimeout(() => {
                document.getElementById('dispatch-modal').style.display = 'block';
            }, 60000);
        }
    }

    function saveTickets() {
        let count = parseInt(document.getElementById('current-tickets').value) || 0;
        shiftData.totalTickets += count;
        shiftData.totalMoney += (count * 5);
        
        document.getElementById('stat-tickets').innerText = shiftData.totalTickets;
        document.getElementById('stat-money').innerText = `${shiftData.totalMoney} USD`;
        document.getElementById('current-tickets').value = 0;
        document.getElementById('ticket-modal').style.display = 'none';

        const station = shiftData.currentRoute.stop[shiftData.currentStationIdx];
        document.getElementById('departure-text').innerText = `Vid√≠ v√Ωpravƒç√≠, ≈æe odj√≠≈æd√≠≈° ze stanice ${station}?`;
        document.getElementById('departure-modal').style.display = 'block';
    }

    function closeDeparture() {
        document.getElementById('departure-modal').style.display = 'none';
        document.getElementById('coin-sound').play();
        
        shiftData.currentStationIdx++;
        if (shiftData.currentStationIdx >= shiftData.currentRoute.stop.length) {
            showFinalReport();
        } else {
            renderTimetable();
        }
    }

    async function showFinalReport() {
        document.getElementById('step-4').classList.add('hidden');
        document.getElementById('step-5').classList.remove('hidden');
        
        let finalRounds = shiftData.initialRounds + shiftData.currentRound;
        let avgDelay = document.getElementById('stat-delay').innerText;

        document.getElementById('final-summary').innerHTML = `
            <h3 style="color:var(--accent); margin-top:0;">V√ùSLEDEK SMƒöNY</h3>
            <strong>Strojv≈Ødce:</strong> ${shiftData.worker}<br>
            <strong>üé´ Prodan√Ωch j√≠zdenek:</strong> ${shiftData.totalTickets}<br>
            <strong>‚è± Koneƒçn√° dochvilnost:</strong> ${avgDelay}<br>
            <strong>üí∞ Celkem vydƒõl√°no:</strong> ${shiftData.totalMoney} USD<br>
            <hr style="border:0; border-top:1px solid #444;">
            <strong>üîÑ Nov√Ω stav historie kol:</strong> ${finalRounds}
        `;

        await fetch(WEBHOOK_LOG, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                embeds: [{
                    title: "CRC - UKONƒåEN√ç SLU≈ΩEBN√çHO PROTOKOLU",
                    fields: [
                        { name: "Zamƒõstnanec", value: shiftData.worker, inline: true },
                        { name: "J√≠zdenky / Zisk", value: `${shiftData.totalTickets} ks / ${shiftData.totalMoney} USD`, inline: true },
                        { name: "Dochvilnost", value: avgDelay, inline: true },
                        { name: "Celkov√° historie kol", value: finalRounds.toString() }
                    ],
                    color: 3066993,
                    footer: { text: "Continental Rail Company - 1899" }
                }]
            })
        });
    }
</script>
</body>
</html>

