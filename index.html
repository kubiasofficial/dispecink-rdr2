<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Dispeƒçink v1.39 - Blackwater Logistics</title>
    <style>
        :root {
            --bg-color: #0d0d0d; --card-bg: rgba(25, 25, 25, 0.98);
            --accent: #c0a060; --danger: #ff4444; --info: #44ccff;
            --success: #4caf50; --border: #3d3d3d;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: #e0e0e0; display: flex; justify-content: center; padding: 20px; }
        .card { background: var(--card-bg); border: 1px solid var(--border); padding: 30px; border-radius: 12px; width: 750px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        
        #setup-mode, #drive-mode, #report-mode { display: none; }
        .active-mode { display: block !important; }

        h2 { color: var(--accent); text-align: center; border-bottom: 2px solid #8b0000; padding-bottom: 15px; text-transform: uppercase; letter-spacing: 5px; margin-top: 0; }
        
        #update-modal {
            display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px);
        }
        .modal-content {
            background: #1a1a1a; margin: 10% auto; padding: 30px; border: 1px solid var(--accent);
            width: 500px; border-radius: 12px; position: relative; box-shadow: 0 0 30px rgba(192, 160, 96, 0.2);
        }
        .close-modal { position: absolute; right: 20px; top: 15px; color: #888; font-size: 28px; cursor: pointer; }

        #notice-board, #management-board { margin-top: 15px; padding: 15px; border-radius: 8px; text-align: center; }
        #notice-board { border: 1px dashed var(--danger); background: rgba(255, 0, 0, 0.05); }
        #management-board { border: 1px solid var(--accent); background: rgba(192, 160, 96, 0.05); }

        .blinking-title { animation: blinker 2s linear infinite; font-weight: 900; color: var(--danger); margin: 0 0 8px 0; letter-spacing: 2px; text-transform: uppercase; }
        .management-title { font-weight: 900; color: var(--accent); margin: 0 0 8px 0; letter-spacing: 2px; text-transform: uppercase; }
        @keyframes blinker { 50% { opacity: 0.3; } }

        #navigator { padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: center; border: 1px solid var(--border); position: relative; }
        .state-station { background: linear-gradient(135deg, #162e4d 0%, #08111d 100%); border-color: var(--info) !important; }
        .state-travel { background: linear-gradient(135deg, #4d2b00 0%, #1a0f00 100%); border-color: #ffa500 !important; }
        
        #nav-timer-container { font-size: 4.5em; font-weight: 800; font-family: 'Courier New', monospace; line-height: 1; }
        .gvd-container { width: 100%; height: 10px; background: #000; border-radius: 5px; margin: 20px 0 10px 0; border: 1px solid #333; overflow: hidden; }
        #gvd-fill { width: 0%; height: 100%; background: linear-gradient(to right, #2196F3, #44ccff); transition: 0.5s; }

        .info-bar { display: flex; justify-content: space-around; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
        .info-item { text-align: center; }
        .info-label { font-size: 0.7em; color: #888; text-transform: uppercase; display: block; }
        .info-val { font-size: 1.2em; font-weight: bold; }

        .btn { padding: 15px 25px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; text-transform: uppercase; transition: 0.2s; width: 100%; }
        .btn-confirm { background: #fff; color: #000; font-size: 1.2em; box-shadow: 0 4px 0 #bbb; margin-top: 15px; }
        .btn-main { background: linear-gradient(to bottom, #8b0000, #5a0000); color: white; margin-top: 20px; }
        .btn-discord { background: #5865F2; color: white; margin-top: 10px; }

        .grid-config { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        label { font-size: 0.75em; color: var(--accent); margin-bottom: 5px; display: block; }
        select, input { background: #222; border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; }
        
        .tg-section { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .tg-box { background: rgba(0,0,0,0.3); border: 1px solid var(--border); padding: 10px; border-radius: 8px; max-height: 120px; overflow-y: auto; font-size: 0.8em; }
        .list { margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px; font-family: monospace; max-height: 200px; overflow-y: auto; }
        .item-row { display: flex; justify-content: space-between; padding: 6px 10px; border-bottom: 1px solid #222; opacity: 0.5; }
        .active-row { opacity: 1; color: var(--accent); background: rgba(192, 160, 96, 0.1); font-weight: bold; }
    </style>
</head>
<body onload="checkUpdate()">

<div id="update-modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeUpdate()">&times;</span>
        <h3 style="color:var(--accent); margin-top:0;">üöÄ AKTUALIZACE v1.39</h3>
        <ul style="font-size: 0.9em; line-height: 1.6; padding-left: 20px;">
            <li><b>üì¢ Blackwater Dispatch:</b> Automatick√© hl√°≈°en√≠ p≈ô√≠jezd≈Ø pro stanici Blackwater na samostatn√Ω webhook.</li>
            <li><b>üß≠ Detekce smƒõru:</b> Inteligentn√≠ rozpozn√°n√≠, zda vlak v BW jede do Saint Denis nebo k jihu.</li>
            <li><b>‚öñÔ∏è Stabilizace:</b> Oprava logov√°n√≠ a synchronizace v≈°ech t≈ô√≠ webhook≈Ø.</li>
        </ul>
        <button class="btn btn-main" onclick="closeUpdate()">ROZUM√çM</button>
    </div>
</div>

<div class="card">
    <h2>üöÇ DISPEƒåINK v1.39</h2>

    <div id="setup-mode" class="active-mode">
        <label>V√ùBƒöR TRASY:</label>
        <select id="routeSelect" onchange="updateStations()" style="margin-bottom: 15px;">
            <option value="hlavni">1. HLAVN√ç OKRUH</option>
            <option value="zapadni">2. Z√ÅPADN√ç SPOJKA</option>
            <option value="vychodni">3. V√ùCHODN√ç DR√ÅHA</option>
            <option value="jizni">4. JI≈ΩN√ç CESTA</option>
        </select>

        <div class="grid-config">
            <div><label>START:</label><input type="time" id="startTime" value="12:00"></div>
            <div><label>KOL DNES:</label><input type="number" id="lapCount" value="1" min="1"></div>
            <div><label>HISTORIE (CELKEM):</label><input type="number" id="prevTotal" value="0" min="0"></div>
            <div><label>PAUZA:</label><input type="number" id="pauseTime" value="5"></div>
        </div>

        <div class="tg-section">
            <div id="tgIn" class="tg-box"></div>
            <div id="tgOut" class="tg-box"></div>
        </div>

        <button class="btn btn-main" onclick="generovat()">‚öôÔ∏è GENEROVAT J√çZDN√ç ≈ò√ÅD</button>

        <div id="notice-board">
            <h4 class="blinking-title">‚ö†Ô∏è OMEZEN√ç A NA≈ò√çZEN√ç ‚ö†Ô∏è</h4>
            <div id="notice-content" style="font-family: monospace; font-size: 0.85em; color: #bbb;">Ve mƒõstech je povinn√© dodr≈æovat rychlost 20 mph.</div>
        </div>

        <div id="management-board">
            <h4 class="management-title">üìú VZKAZY OD VEDEN√ç</h4>
            <div id="management-content" style="font-family: 'Segoe UI', serif; font-size: 0.9em; color: #ccc; font-style: italic;">
                Dbejte zv√Ω≈°en√© opatrnosti p≈ôi pr≈Øjezdu stanicemi. 
            </div>
        </div>

        <button id="startBtn" class="btn btn-discord" style="display:none;" onclick="startDrive()">üöÄ ODESLAT NA DISCORD & ODJET</button>
        <div id="preview-list" class="list"></div>
    </div>

    <div id="drive-mode">
        <div class="info-bar">
            <div class="info-item"><span class="info-label">Dochvilnost</span><span id="hud-delay" class="info-val">VƒåAS</span></div>
            <div class="info-item"><span class="info-label">Zb√Ωv√° zast√°vek</span><span id="hud-remaining" class="info-val">--</span></div>
            <div class="info-item"><span class="info-label">Tr≈æba</span><span id="hud-cash" class="info-val">0 $</span></div>
        </div>

        <div id="navigator">
            <div style="display:flex; justify-content: space-between; font-weight: bold; color: var(--accent);">
                <span id="hud-planned-label">P≈ò√çJEZD:</span><span id="hud-planned-time">--:--</span>
            </div>
            <div id="nav-main" style="font-size: 2em; font-weight: 900; margin: 10px 0;">STATION ‚ûî STATION</div>
            <div id="nav-timer-container">0:00</div>
            <div class="gvd-container"><div id="gvd-fill"></div></div>
            <button id="confirmBtn" class="btn btn-confirm" onclick="handleAction()">POTVRDIT P≈ò√çJEZD</button>
        </div>
        <div id="active-list" class="list"></div>
    </div>

    <div id="report-mode" style="text-align: center;">
        <h3 style="color:var(--success)">‚úÖ SMƒöNA DOKONƒåENA</h3>
        <div id="final-stats" style="background:rgba(0,0,0,0.3); padding:20px; border-radius:8px; margin-bottom:20px; text-align:left; line-height:2.2;"></div>
        <button class="btn btn-main" onclick="resetApp()">üîÑ NOV√Å SMƒöNA</button>
    </div>
</div>

<script>
    const VERSION = "1.39";
    // T≈òI SAMOSTATN√â WEBHOOKY
    const WEBHOOK_LOG = "https://discord.com/api/webhooks/1462379181290553378/7szxSP1bgAiR1diwDixyPPrXxklYWVGdLn3xZy8czqxGbqda9wtryXNV_zqJXL3PHGKO";
    const WEBHOOK_RAD = "https://discord.com/api/webhooks/1462391755864277033/mQ1n6EsyC-yEuEc7hZTYsm8Jt9VjnUGr-jPVM2qjvVSSkisoS2Cpl1DSi1Oe7lUnBd6J";
    const WEBHOOK_BW = "https://discord.com/api/webhooks/1463245037834862616/M_myizEOqBJjE84_5MKqNQdRlY4S1P6EHBA3JnYxOw2mdYYn0kt609sc8MIz1v3e4PkV";
    
    const dataTras = {
        hlavni: { nazev: "1. HLAVN√ç OKRUH", zastavky: [{n: "Saint Denis", d: 3}, {n: "Emerald", d: 4}, {n: "Valentine", d: 3}, {n: "Flatneck", d: 3}, {n: "Riggs", d: 3}, {n: "Wallace", d: 5}, {n: "Bacchus", d: 5}, {n: "Annesburg", d: 2.5}, {n: "Van Horn", d: 4}, {n: "Saint Denis (C√çL)", d: 0}]},
        zapadni: { nazev: "2. Z√ÅPADN√ç SPOJKA", zastavky: [{n: "Saint Denis", d: 3}, {n: "Rhodes", d: 5}, {n: "Flatneck", d: 4}, {n: "Blackwater", d: 4.5}, {n: "MacFarlane", d: 2}, {n: "Montana", d: 3}, {n: "Flatneck ", d: 2.5}, {n: "Valentine", d: 4.5}, {n: "Saint Denis (C√çL)", d: 0}]},
        vychodni: { nazev: "3. V√ùCHODN√ç DR√ÅHA", zastavky: [{n: "Saint Denis", d: 3}, {n: "Van Horn", d: 2}, {n: "Annesburg", d: 4.5}, {n: "Bacchus", d: 4}, {n: "Wallace", d: 2.5}, {n: "Riggs", d: 2.5}, {n: "Flatneck", d: 3}, {n: "Rhodes", d: 3}, {n: "Saint Denis (C√çL)", d: 0}]},
        jizni: { nazev: "4. JI≈ΩN√ç CESTA", zastavky: [{n: "Saint Denis", d: 4.5}, {n: "Valentine", d: 2.5}, {n: "Flatneck", d: 3}, {n: "Blackwater", d: 4}, {n: "MacFarlane", d: 4}, {n: "Armadillo", d: 2}, {n: "Mercer", d: 6}, {n: "Benedict", d: 3}, {n: "Mercer ", d: 2}, {n: "Armadillo ", d: 4}, {n: "MacFarlane ", d: 4}, {n: "Blackwater ", d: 3}, {n: "Flatneck ", d: 2.5}, {n: "Valentine ", d: 4.5}, {n: "Saint Denis (C√çL)", d: 0}]}
    };

    let state = { delay: 0, tickets: 0, icName: "", navBody: [], currentIndex: 0, interval: null, smenaData: [], routeName: "", previousTotal: 0 };

    function checkUpdate() {
        if (localStorage.getItem('icName')) state.icName = localStorage.getItem('icName');
        if (localStorage.getItem('prevTotal')) document.getElementById('prevTotal').value = localStorage.getItem('prevTotal');
        if (localStorage.getItem('lastVersion') !== VERSION) { document.getElementById('update-modal').style.display = "block"; }
        updateStations();
    }

    function closeUpdate() { localStorage.setItem('lastVersion', VERSION); document.getElementById('update-modal').style.display = "none"; }

    function updateStations() {
        const route = dataTras[document.getElementById('routeSelect').value];
        const inC = document.getElementById('tgIn'); const outC = document.getElementById('tgOut');
        inC.innerHTML = "<b>üì• NAKL√ÅDKA</b><br>"; outC.innerHTML = "<b>üì§ VYKL√ÅDKA</b><br>";
        route.zastavky.forEach(s => {
            if(!s.n.includes("(C√çL)")) {
                inC.innerHTML += `<label><input type="checkbox" class="check-in" value="${s.n}"> ${s.n}</label>`;
                outC.innerHTML += `<label><input type="checkbox" class="check-out" value="${s.n}"> ${s.n}</label>`;
            }
        });
    }

    function generovat() {
        state.navBody = []; state.smenaData = [];
        const routeKey = document.getElementById('routeSelect').value;
        state.routeName = dataTras[routeKey].nazev;
        const laps = parseInt(document.getElementById('lapCount').value);
        const pause = parseInt(document.getElementById('pauseTime').value);
        const startStr = document.getElementById('startTime').value.split(':');
        let curMin = parseInt(startStr[0]) * 60 + parseInt(startStr[1]);
        const inS = Array.from(document.querySelectorAll('.check-in:checked')).map(cb => cb.value);
        const outS = Array.from(document.querySelectorAll('.check-out:checked')).map(cb => cb.value);

        for (let l = 1; l <= laps; l++) {
            let lapDesc = "";
            dataTras[routeKey].zastavky.forEach((s, i) => {
                let bonus = (inS.includes(s.n.trim()) ? 1.5 : 0) + (outS.includes(s.n.trim()) ? 1.5 : 0);
                let arrival = curMin + (i > 0 ? dataTras[routeKey].zastavky[i-1].d : 0);
                if (i > 0) state.navBody.push({ type: 'travel', from: dataTras[routeKey].zastavky[i-1].n, to: s.n, start: curMin, end: arrival });
                curMin = arrival + bonus;
                let telegramTag = (inS.includes(s.n.trim()) && outS.includes(s.n.trim())) ? " [üì•üì§ PO≈†TA]" : inS.includes(s.n.trim()) ? " [üì• NAKL√ÅDKA]" : outS.includes(s.n.trim()) ? " [üì§ VYKL√ÅDKA]" : "";
                lapDesc += `\`${formatTime(curMin)}\` **${s.n}**${telegramTag}\n`;
                state.navBody.push({ type: 'station', name: s.n, start: arrival, end: curMin, stationIndex: i });
            });
            state.smenaData.push({ title: `${l}. KOLO`, desc: lapDesc });
            if (l < laps) { state.navBody.push({ type: 'pause', start: curMin, end: curMin + pause }); curMin += pause; }
        }
        document.getElementById('startBtn').style.display = "block";
        renderList('preview-list');
    }

    async function startDrive() {
        let nameInput = prompt("Potvrƒè sv√© IC Jm√©no:", state.icName || "");
        if(!nameInput) return;
        state.icName = nameInput; localStorage.setItem('icName', nameInput);
        switchMode('drive-mode');

        // LOGOV√ÅN√ç STARTU
        fetch(WEBHOOK_LOG, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({
            username: "V√Ωpravƒç√≠", embeds: [{ title: "üöÇ START SMƒöNY", description: `**Strojv≈Ødce:** ${state.icName}\n**Trasa:** ${state.routeName}`, color: 3066993 }]
        })});

        // BLACKWATER DISPATCH LOGIKA
        const datumStr = `${new Date().getDate()}.${new Date().getMonth() + 1}.1899`;
        state.navBody.forEach(item => {
            if (item.type === 'station' && item.name.toLowerCase().includes('blackwater')) {
                let smer = "";
                if (state.routeName.includes("Z√ÅPADN√ç")) { smer = "Saint Denis"; }
                else if (state.routeName.includes("JI≈ΩN√ç")) { smer = (item.stationIndex > 8) ? "Saint Denis" : "Benedict Point"; }
                
                if(smer !== "") {
                    fetch(WEBHOOK_BW, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({
                        content: `${datumStr} ${state.routeName} - smƒõr ${smer} p≈ô√≠jezd ${formatTime(item.start)}`
                    })});
                }
            }
        });

        // ODESL√ÅN√ç J√çZDN√çCH ≈ò√ÅD≈Æ
        for(let lap of state.smenaData) {
            await new Promise(r => setTimeout(r, 600));
            fetch(WEBHOOK_RAD, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({
                username: "J√≠zdn√≠ ≈ò√°d", embeds: [{ title: lap.title + " | " + state.icName, description: lap.desc, color: 3447003 }]
            })});
        }
        runNavigator(); renderList('active-list');
    }

    function runNavigator() {
        state.interval = setInterval(() => {
            const active = state.navBody[state.currentIndex];
            if (!active) { finishSmƒõna(); return; }
            const nowMin = new Date().getHours() * 60 + new Date().getMinutes() + (new Date().getSeconds() / 60);
            let remains = Math.round(((active.end + state.delay) - nowMin) * 60);
            document.getElementById('nav-timer-container').innerText = remains < 0 ? "0:00" : `${Math.floor(remains/60)}:${(remains%60).toString().padStart(2,'0')}`;
            document.getElementById('hud-planned-time').innerText = formatTime(active.end + state.delay);
            document.getElementById('nav-main').innerText = active.type === 'station' ? `üìç ${active.name}` : (active.type === 'pause' ? "‚òï PAUZA SD" : `${active.from} ‚ûî ${active.to}`);
            document.getElementById('navigator').className = active.type === 'station' ? "state-station" : "state-travel";
            const progress = Math.round((state.currentIndex / state.navBody.length) * 100);
            document.getElementById('gvd-fill').style.width = progress + "%";
            document.getElementById('hud-remaining').innerText = state.navBody.slice(state.currentIndex).filter(b => b.type === 'station').length;
        }, 1000);
    }

    function handleAction() {
        const active = state.navBody[state.currentIndex];
        if (active.type === 'travel') {
            let t = prompt("Poƒçet prodan√Ωch j√≠zdenek:", "0");
            state.tickets += (parseInt(t) || 0);
            document.getElementById('hud-cash').innerText = `${state.tickets * 5} $`;
        }
        const nowMin = new Date().getHours() * 60 + new Date().getMinutes() + (new Date().getSeconds() / 60);
        state.delay += (nowMin - (active.end + state.delay));
        state.currentIndex++; renderList('active-list');
    }

    async function finishSmƒõna() {
        clearInterval(state.interval); switchMode('report-mode');
        const lapsNow = parseInt(document.getElementById('lapCount').value);
        const totalAfter = (parseInt(localStorage.getItem('prevTotal')) || 0) + lapsNow;
        localStorage.setItem('prevTotal', totalAfter);
        
        document.getElementById('final-stats').innerHTML = `<b>üë§ Strojv≈Ødce:</b> ${state.icName}<br><b>üìà Kola:</b> ${lapsNow} (Celkem: ${totalAfter})<br><b>üé´ J√≠zdenky:</b> ${state.tickets} ks ($ ${state.tickets * 5})`;
        
        // OPRAVEN√Å ZPR√ÅVA NA DISCORD
        fetch(WEBHOOK_LOG, { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({
                username: "V√Ωkaz", 
                embeds: [{ 
                    title: "üèÅ SMƒöNA DOKONƒåENA", 
                    description: `**Strojv≈Ødce:** ${state.icName}\n**Dnes odjeto:** ${lapsNow} kol\n**Historie celkem:** ${totalAfter} kol\n**Prodan√© j√≠zdenky:** ${state.tickets} ks\n**Tr≈æba:** ${state.tickets * 5} $`, 
                    color: 15844367 
                }]
            })
        });
    }

    function resetApp() { location.reload(); }
    function switchMode(id) {
        document.querySelectorAll('#setup-mode, #drive-mode, #report-mode').forEach(m => m.classList.remove('active-mode'));
        document.getElementById(id).classList.add('active-mode');
    }
    function renderList(targetId) {
        const list = document.getElementById(targetId); list.innerHTML = "";
        state.navBody.forEach((b, i) => {
            if (b.type === 'station') {
                const row = document.createElement('div');
                row.className = `item-row ${i === state.currentIndex ? 'active-row' : ''}`;
                row.innerHTML = `<span>${b.name}</span><b>${formatTime(b.end + state.delay)}</b>`;
                list.appendChild(row);
            }
        });
    }
    function formatTime(m) { return `${Math.floor(m/60)%24}:${(Math.floor(m%60)).toString().padStart(2,'0')}`; }
</script>
</body>
</html>
